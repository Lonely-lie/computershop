<div th:fragment="html">
    <script>
        $(function(){
            var oiid = getUrlParms("oiid");
            var pid = getUrlParms("pid");
            var num = getUrlParms("num");
            var data4Vue = {
                uri:'forebuy',
                total:0,
                orderItems:[],
                userAddresses:[],
                order:{
                    user_address_id:null,
                    user_id:null,
                    userMessage:'',//用户备注信息
                    is_delete:0
                },
                user_ad:{
                    contact_name:'',
                    cel_phone:'',
                    big_address:'',
                    detail_address:''
                },//空表
                form_user_ad:{
                    contact_name:'',
                    cel_phone:'',
                    big_address:'',
                    detail_address:''
                },//
            };
            //ViewModel
            var vue = new Vue({
                el: '#workingArea',
                data: data4Vue,
                mounted:function(){ //mounted　表示这个 Vue 对象加载成功了
                    this.load();
                },
                methods: {
                    load:function(){
                        if (oiid!==null){//从购物车中结算，进入提交订单页面结算
                            var url =  this.uri+"2/?oiid="+oiid;
                            axios.get(url).then(function(response) {
                                var result = response.data;
                                vue.total = result.data.total;
                                vue.orderItems = result.data.orderItems;
                                vue.userAddresses = result.data.userAddresses;

                                vue.$nextTick(function(){
                                    linkDefaultActions();
                                    radioDefault();//给radio默认选择第一个
                                })
                            });
                            return ;
                        }
                        var url =  this.uri+"/?pid="+pid+"&num="+num;
                        axios.get(url).then(function(response) {
                            var result = response.data;
                            vue.total = result.data.total;
                            vue.userAddresses = result.data.userAddresses;
                            vue.orderItems = result.data.orderItems;

                            vue.$nextTick(function(){
                                linkDefaultActions();
                                radioDefault();//给radio默认选择第一个
                            })
                        });
                    },
                    submitOrder:function(){//提交订单
                        var url =  "foreCreateOrder";
                        var mapData = {
                            "order":this.order,
                            "orderItems":this.orderItems,
                            "oiid":oiid
                        }
                        this.order.user_address_id= parseInt($('.myRadio input:radio:checked').val());
                        axios.post(url,mapData).then(function(response) {
                            var result = response.data;
                            var oid = result.data.oid;
                            var total = result.data.total;
                            location.href="alipay?oid="+oid+"&total="+total;
                        });
                    },
                    getRadioValue:function (){//测试
                        var check = $('.myRadio input:radio:checked').val();
                        return parseInt(check);
                    },
                    //限制输入数字最大值和最小值,和显示总价格的变化
                    numberInput:function (oi){
                        if (!(oi.number%1 === 0))
                            return oi.number=1;
                        if (oi.number>oi.product.rest_stock) {
                            oi.number=oi.product.rest_stock;
                        }
                        if (oi.number<1){
                            oi.number=1;
                        }
                        var all =0;
                        for (var i=0;i<vue.orderItems.length;i++){
                            var one =vue.orderItems[i].number*vue.orderItems[i].product.pro_price;
                            all += one;
                        }
                        this.total = all;
                    },
                    addUserAd:function (){
                        axios.post("addUserAd", this.form_user_ad)
                            .then(function (response) {
                                var result = response.data;
                                if (result.code===0){
                                    vue.load();
                                    toastr.success("添加成功！");
                                    vue.form_user_ad = JSON.parse(JSON.stringify(vue.user_ad));//老师代码
                                    $('#addUserAddress').modal('hide');

                                }else {
                                    alert("添加错误，请重新登录!");
                                    location.href="login";
                                }
                            })
                            .catch(function (error) {
                                console.log(error);
                            });
                    },
                }
            });
        })
    </script>
    <div class="buyPageDiv">
        <div class="buyFlow">
<!--            <img class="pull-left" src="img/site/simpleLogo.png">-->
            <img class="pull-right" src="img/site/buyflow.png">
            <div style="clear:both"></div>
        </div>
        <div class="address">
            <div class="addressTip">输入收货地址</div>
            <div>
                <form>
                    <div v-for="ad,index in userAddresses" class="myRadio" >
                        <div class="radio" style="padding: 5px" >
                            <label class="myLabel" onmouseenter="this.className='hover'" onmouseleave="this.className='hoverOut'" style="padding: 0px;font-size: x-large">
                                <input type="radio" name="optionsRadios" :class="'myRadio'+ad.id" :id="'adRadios'+index" :value="ad.id"  >&nbsp&nbsp
                                <strong>{{ad.contact_name}}</strong>
                                <span>{{ad.cel_phone}}</span>
                                <span>{{ad.big_address}}</span>
                                <span>{{ad.detail_address}}</span>
                            </label>
                        </div>

                    </div>
                    <div v-if="userAddresses.length===0">
                        <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#addUserAddress">
                            添加地址
                        </button>
                    </div>
                    <div class="modal " id="addUserAddress" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" >
                        <div class="modal-dialog ">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
                                    <h4 class="modal-title">添加地址</h4>
                                </div>
                                <div class="modal-body">
                                    <form class="form-horizontal" role="form" id="form-menu4">
                                        <div class="form-group">
                                            <label for="big_address" class="col-sm-2 control-label">地址信息</label>
                                            <div class="col-sm-10">
                                                <input type="text" class="form-control" id="big_address" placeholder="请输入地址信息" v-model="form_user_ad.big_address">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="detail_address" class="col-sm-2 control-label">详细地址</label>
                                            <div class="col-sm-10">
                                                <input type="text" class="form-control" id="detail_address" placeholder="请输入详细地址" v-model="form_user_ad.detail_address">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="contact_name" class="col-sm-2 control-label">收货人姓名</label>
                                            <div class="col-sm-10">
                                                <input type="text" class="form-control" id="contact_name" placeholder="请输入收货人姓名" v-model="form_user_ad.contact_name">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="cel_phone" class="col-sm-2 control-label">收货人电话</label>
                                            <div class="col-sm-10">
                                                <input type="text" class="form-control" id="cel_phone" placeholder="请输入收货人导航" v-model="form_user_ad.cel_phone">
                                            </div>
                                        </div>

                                    </form>

                                </div>
                                <div class="modal-footer">
                                    <button data-dismiss="modal" class="btn btn-default" type="button">关闭</button>
                                    <button class="btn btn-primary deleteConfirmButton" id="submit" type="button" @click="addUserAd">确认</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="productList">
            <div class="productListTip">确认订单信息</div>

            <table class="productListTable">
                <thead>
                <tr>
                    <th colspan="2" class="productListTableFirstColumn">
                        <img class="tmallbuy" src="img/site/tmallbuy.png">
                        <a class="marketLink" href="#nowhere">店铺：天猫店铺</a>
                        <a class="wangwanglink" href="#nowhere"> <span class="wangwangGif"></span> </a>
                    </th>
                    <th>单价</th>
                    <th>数量</th>
                    <th>小计</th>
                    <th>配送方式</th>
                </tr>
                <tr class="rowborder">
                    <td  colspan="2" ></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                </thead>
                <tbody class="productListTableTbody">
                <tr class="orderItemTR" v-for="oi,index in orderItems" >
                    <td class="orderItemFirstTD">
                        <img class="orderItemImg"  :src="'img/productSingle_middle/'+oi.product.firstProductImage.id+'.jpg'">
                    </td>
                    <td class="orderItemProductInfo">
                        <a  :href="'product?pid='+oi.product.id" class="orderItemProductLink">
                            {{oi.product.name}}
                        </a>
                        <img src="img/site/creditcard.png" title="支持信用卡支付">
                        <img src="img/site/7day.png" title="消费者保障服务,承诺7天退货">
                        <img src="img/site/promise.png" title="消费者保障服务,承诺如实描述">
                    </td>
                    <td>
								<span class="orderItemProductPrice">
									{{oi.product.pro_price | formatMoneyFilter}}
								</span>
                    </td>
                    <td>
                        <span>
                            <span class="productNumberSettingSpan">
                                <input class="productNumberSetting" style="width: 50px" type="number" v-model.number="oi.number"  @input="numberInput(oi)">
                            </span>
                        件</span>
                    </td>
                    <td>
								<span class="orderItemUnitSum">
									{{oi.product.pro_price*oi.number | formatMoneyFilter}}
								</span>
                    </td>
                    <td rowspan="5" class="orderItemLastTD" v-if="index==0" >
                        <label class="orderItemDeliveryLabel">
                            <input type="radio" value="" checked="checked">
                            普通配送
                        </label>
                        <select class="orderItemDeliverySelect" >
                            <option>快递 免邮费</option>
                        </select>
                    </td>
                </tr>
                </tbody>
            </table>
            <div class="orderItemSumDiv">
                <div class="pull-left">
                    <span class="leaveMessageText">给卖家留言:</span>
                    <span>
						<img class="leaveMessageImg" src="img/site/leaveMessage.png">
					</span>
                    <span class="leaveMessageTextareaSpan">
						<textarea name="userMessage" v-model="order.userMessage" class="leaveMessageTextarea"></textarea>
						<div>
							<span>还可以输入200个字符</span>
						</div>
					</span>
                </div>
                <span class="pull-right">店铺合计(含运费): ￥
					{{total|formatMoneyFilter}}
				</span>
            </div>

        </div>
        <div class="orderItemTotalSumDiv">
            <div class="pull-right">
                <span>实付款：</span>
                <span class="orderItemTotalSumSpan">{{total|formatMoneyFilter}}</span>
            </div>
        </div>
        <div class="submitOrderDiv">
            <button type="submit" class="submitOrderButton" @click="submitOrder">提交订单</button>
        </div>
    </div>
</div>
